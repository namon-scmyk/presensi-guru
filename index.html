<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aplikasi absensi guru berbasis web" />
  <meta name="keywords" content="absensi, guru, sekolah" />
  <meta name="author" content="SMK Negeri XXX" />
  <title>Absensi Guru</title>
  <!-- Ikon untuk iPhone & PWA -->
  <link rel="apple-touch-icon" href="/icon.png" />
  <link rel="apple-touch-startup-image" href="/icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#1a73e8" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --bg: #f8f9fa;
      --text: #212529;
      --primary: #1a73e8;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --card-bg: #ffffff;
      --border: #dee2e6;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --text: #e0e0e0;
        --card-bg: #1e1e1e;
        --border: #333;
      }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      color: var(--text);
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7'%3E%3Cpath fill='%231a73e8' d='M0 0l6 6 6-6z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 12px;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .btn {
      flex: 1;
      min-width: 120px;
      padding: 16px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:active {
      transform: scale(0.98);
    }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-masuk {
      background: var(--primary);
      color: white;
    }
    .btn-keluar {
      background: var(--danger);
      color: white;
    }
    .btn-retry, .btn-reset {
      background: #6c757d;
      color: white;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1rem;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
    }
    .success {
      color: var(--success);
    }
    .error {
      color: var(--danger);
    }
    .warning {
      color: var(--warning);
    }
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      h1 {
        font-size: 1.6rem;
      }
      .btn {
        font-size: 15px;
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìù Absensi Guru</h1>
    </header>

    <div class="form-group">
      <label for="mapel">Mata Pelajaran:</label>
      <select id="mapel" aria-label="Pilih mata pelajaran">
        <option value="">-- Pilih Mata Pelajaran --</option>
        <option value="PAI dan BP">PAI dan BP</option>
        <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
        <option value="Matematika">Matematika</option>
        <option value="Fisika">Fisika</option>
        <option value="Kimia">Kimia</option>
        <option value="Biologi">Biologi</option>
        <option value="Sosiologi">Sosiologi</option>
        <option value="Ekonomi">Ekonomi</option>
        <option value="Sejarah">Sejarah</option>
        <option value="Sejarah">Sejarah Peminatan</option>
        <option value="Geografi">Geografi</option>
        <option value="Bahasa Inggris">Bahasa Inggris</option>
        <option value="PJOK">PJOK</option>
        <option value="Informatika">Informatika</option>
        <option value="Seni Budaya">Seni Budaya</option>
        <option value="Bimbingan Konseling">Bimbingan Konseling</option>
        <option value="Koding & KA">Koding & KA</option>
      </select>
    </div>

    <div class="form-group">
      <label for="kelas">Kelas:</label>
      <select id="kelas" aria-label="Pilih kelas">
        <option value="">-- Pilih Kelas --</option>
        <option value="10-1">10-1</option>
        <option value="10-2">10-2</option>
        <option value="10-3">10-3</option>
        <option value="10-4">10-4</option>
        <option value="10-5">10-5</option>
        <option value="10-6">10-6</option>
        <option value="10-7">10-7</option>
        <option value="10-8">10-8</option>
        <option value="10-9">10-9</option>
        <option value="10-10">10-10</option>
        <option value="10-11">10-11</option>
        <option value="11-1">11-1</option>
        <option value="11-2">11-2</option>
        <option value="11-3">11-3</option>
        <option value="11-4">11-4</option>
        <option value="11-5">11-5</option>
        <option value="11-6">11-6</option>
        <option value="11-7">11-7</option>
        <option value="11-8">11-8</option>
        <option value="11-9">11-9</option>
        <option value="11-10">11-10</option>
        <option value="12-1">12-1</option>
        <option value="12-2">12-2</option>
        <option value="12-3">12-3</option>
        <option value="12-4">12-4</option>
        <option value="12-5">12-5</option>
        <option value="12-6">12-6</option>
        <option value="12-7">12-7</option>
        <option value="12-8">12-8</option>
        <option value="12-9">12-9</option>
        <option value="12-10">12-10</option>
        <option value="12-11">12-11</option>
      </select>
    </div>

    <div class="form-group">
      <label for="guru">Nama Guru:</label>
      <select id="guru" aria-label="Pilih nama guru">
        <option value="">-- Pilih Nama Anda --</option>
        <!-- Daftar guru akan diisi otomatis berdasarkan mapel -->
      </select>
      <button class="btn btn-reset" onclick="resetGuru()" aria-label="Ganti guru" style="margin-top: 10px;">Ganti Guru</button>
    </div>

    <div class="btn-group">
      <button class="btn btn-masuk" onclick="absen('masuk')" aria-label="Absen masuk">Masuk</button>
      <button class="btn btn-keluar" onclick="absen('keluar')" aria-label="Absen keluar">Keluar</button>
    </div>

    <p id="result"></p>
  </div>

  <script>
    // Daftar guru berdasarkan mata pelajaran
    const guruByMapel = {
      "PAI dan BP": [
        "Sasmawati D. Halid, S.Ag",
        "Asni Pakaya, S.PdI",
        "Khaeroni, S.PdI",
        "Sri Mulyati Mayang, S.Ag"
      ],
      "Pendidikan Pancasila": [
        "Taufik Amuntu, S.Pd",
        "Isna Husain, S.Pd",
        "Azis Abdullah, S.Pd"
      ],
      "Bahasa Indonesia": [
        "Mustapa Dako, S.Pd",
        "Dian Ariyani Lapai, S.Pd",
        "Oktaviani Iko, S.Pd",
        "Nuriyadin Kunuti, S.Pd",
        "Oman Wahiji, S.Pd",
        "Nur Azizah R. Koping, S.Pd"
      ],
      "Matematika": [
        "Nurfitriani Buhungo, S.Pd",
        "Mohamad Adnan Ibrahim, S.Pd",
        "Sri Saputri Mayang, S.Pd",
        "Esti Nofriani Ali, S.Pd",
        "Nur Azizah R. Koping, S.Pd"
      ],
      "Fisika": [
        "Fatmawati Saleh, S.Pd",
        "Reny M. Sahrain, M.Pd",
        "Mayariskawati Karim, S.Pd",
        "Erni Podungge, M.M."
      ],
      "Kimia": [
        "Fristo Kau, M.Pd",
        "Fatmah F. Musa, S.Pd",
        "Ram Ibrahim, S.Pd",
        "Rahmad Utina, M.Pd"
      ],
      "Biologi": [
        "Hartiman, S.Pd",
        "Dra. Zubaida S. Bialangi",
        "Susantiana A. Husain, S.Pd"
      ],
      "Sosiologi": [
        "Yeri Prasetya Haipi, S.Pd"
      ],
      "Ekonomi": [
        "Leni Marlina Abas, S.Pd",
        "Agustin Hasania, S.Pd",
        "Kartin Moli, S.Pd"
      ],
      "Sejarah": [
        "Linda Banto, S.Pd",
        "Fahril Ramadhan Yusuf, S.Pd",
        "Irawaty AS. Ali, M.Pd",
        "Dra. Agustina Pianus",
        "Lutfiah R. Bagu, S.Pd"
      ],
      "Sejarah Peminatan": [
        "Linda Banto, S.Pd",
        "Fahril Ramadhan Yusuf, S.Pd",
        "Irawaty AS. Ali, M.Pd",
        "Dra. Agustina Pianus",
        "Lutfiah R. Bagu, S.Pd"
      ],
      "Geografi": [
        "Zakir Inggile, S.Pd",
        "Fifiati, S.Pd"
      ],
      "Bahasa Inggris": [
        "Hj. Ramlah H. Hasan, M.Pd",
        "Selfi Katili, M.Pd",
        "Drs. Hi. Abdul Razak Husain, M.Ed",
        "Umar, M.Pd"
      ],
      "PJOK": [
        "Drs. Jhon A.R. Yusuf",
        "Marten Nuna, S.Pd",
        "Nuriyadin Kunuti, S.Pd",
        "Oman Wahiji, S.Pd"
      ],
      "Informatika": [
        "Gabriela J. Tangkawarow, S.Pd",
        "Herson Mustapa, S.SI",
        "Newin Kalay, S.SI",
        "Mirsan Kuka, S.Kom"
      ],
      "Seni Budaya": [
        "Febriana Polontalo, S.Pd",
        "Fita R. Naue, S.Pd"
      ],
      "Bimbingan Konseling": [
        "Arlin Husnan, S.Pd",
        "Karmila P. Paino, S.Pd",
        "Meri Novianti, S.Pd",
        "Nanda Oktaviany S. Djafar, S.Pd"
      ],
      "Koding & KA": [
        "Sutrisno Tilahunga, SE"
      ]
    };

    // DOM Elements
    const mapelSelect = document.getElementById('mapel');
    const kelasSelect = document.getElementById('kelas');
    const guruSelect = document.getElementById('guru');
    const result = document.getElementById('result');

    // Update daftar guru berdasarkan mapel
    mapelSelect.addEventListener('change', () => {
      const mapel = mapelSelect.value;
      guruSelect.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
      
      if (mapel && guruByMapel[mapel]) {
        guruByMapel[mapel].forEach(guru => {
          const option = document.createElement('option');
          option.value = guru;
          option.textContent = guru;
          guruSelect.appendChild(option);
        });
      }
      
      // Reset nama guru yang tersimpan
      localStorage.removeItem('namaGuru');
      guruSelect.disabled = false;
    });

    // Cek nama guru dari localStorage
    const savedGuru = localStorage.getItem('namaGuru');
    if (savedGuru) {
      guruSelect.value = savedGuru;
      guruSelect.disabled = true;
    }

    // üî• URL BACKEND ANDA
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyUwNGtKZhsBaB1ppn5_lr5qwGVxz_tZxPATnFBu00u5W6hamisTtzeeGhY76m87O-C/exec';

    // Fungsi untuk format waktu lokal (WITA)
    const formatTime = () => {
      const date = new Date();
      const options = { 
        year: 'numeric', 
        month: 'short', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit', 
        timeZone: 'Asia/Makassar' 
      };
      return date.toLocaleString('id-ID', options);
    };

    // Fungsi untuk reset nama guru
    function resetGuru() {
      localStorage.removeItem('namaGuru');
      localStorage.removeItem('pendingAbsensi');
      guruSelect.value = '';
      guruSelect.disabled = false;
      result.innerHTML = `<span class="success">‚úÖ Nama guru direset. Silakan pilih nama baru.</span>`;
    }

    // Fungsi absen - INTEGRASI DENGAN BACKEND
    let isProcessing = false;
    async function absen(tipe) {
      if (isProcessing) return;
      isProcessing = true;

      const mapel = mapelSelect.value?.trim();
      const kelas = kelasSelect.value?.trim();
      const nama = guruSelect.value?.trim();

      // Validasi input
      if (!mapel) {
        result.innerHTML = `<span class="error">‚ùå Pilih mata pelajaran dulu.</span>`;
        isProcessing = false;
        return;
      }

      if (!kelas) {
        result.innerHTML = `<span class="error">‚ùå Pilih kelas dulu.</span>`;
        isProcessing = false;
        return;
      }

      if (!nama) {
        result.innerHTML = `<span class="error">‚ùå Pilih nama Anda dulu.</span>`;
        isProcessing = false;
        return;
      }

      // Simpan nama guru
      localStorage.setItem('namaGuru', nama);

      // Nonaktifkan tombol dan tampilkan loading
      document.querySelectorAll('.btn:not(.btn-reset)').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.7';
      });
      result.textContent = 'Mengirim...';

      // Data yang akan dikirim
      const data = {
        guru: nama,
        mapel: mapel,
        kelas: kelas,
        tipe: tipe
      };

      try {
        // Tambahkan delay acak untuk menghindari beban bersamaan
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000));
        
        // Kirim ke backend
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data),
          redirect: 'follow',
          muteHttpExceptions: true
        });

        const responseText = await res.text();
        let responseJson;
        
        try {
          responseJson = JSON.parse(responseText);
        } catch (e) {
          throw new Error('Respon tidak valid dari server');
        }

        if (responseJson.status === 'success') {
          result.innerHTML = `<span class="success">‚úÖ Berhasil! Absensi ${tipe} tercatat pada ${formatTime()}.</span>`;
          localStorage.removeItem('pendingAbsensi');
        } else {
          throw new Error(responseJson.message || 'Gagal menyimpan data');
        }
        
      } catch (err) {
        result.innerHTML = `<span class="error">‚ùå Gagal: ${err.message || 'Periksa koneksi internet.'}</span>`;
        localStorage.setItem('pendingAbsensi', JSON.stringify(data));
        result.innerHTML += `<br><button class="btn btn-retry" onclick="retryAbsen()">Coba Lagi</button>`;
      } finally {
        isProcessing = false;
        document.querySelectorAll('.btn:not(.btn-reset)').forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
        });
      }
    }

    // Fungsi untuk retry absensi yang gagal
    async function retryAbsen() {
      const pendingData = localStorage.getItem('pendingAbsensi');
      if (!pendingData) {
        result.innerHTML = `<span class="error">‚ùå Tidak ada data pending untuk dikirim.</span>`;
        return;
      }

      const data = JSON.parse(pendingData);
      result.textContent = 'Mencoba ulang...';

      try {
        // Tambahkan delay acak
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000));
        
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data),
          redirect: 'follow',
          muteHttpExceptions: true
        });

        const responseText = await res.text();
        let responseJson;
        
        try {
          responseJson = JSON.parse(responseText);
        } catch (e) {
          throw new Error('Respon tidak valid dari server');
        }

        if (responseJson.status === 'success') {
          result.innerHTML = `<span class="success">‚úÖ Berhasil! Absensi ${data.tipe} tercatat pada ${formatTime()}.</span>`;
          localStorage.removeItem('pendingAbsensi');
        } else {
          throw new Error(responseJson.message || 'Gagal menyimpan data');
        }
      } catch (err) {
        result.innerHTML = `<span class="error">‚ùå Gagal: ${err.message || 'Periksa koneksi internet.'}</span>`;
        result.innerHTML += `<br><button class="btn btn-retry" onclick="retryAbsen()">Coba Lagi</button>`;
      }
    }

    // Cek jika ada data pending saat halaman dimuat
    window.addEventListener('DOMContentLoaded', () => {
      const pending = localStorage.getItem('pendingAbsensi');
      if (pending) {
        result.innerHTML = `<span class="warning">‚ö†Ô∏è Anda memiliki absensi yang belum terkirim.</span>`;
        result.innerHTML += `<br><button class="btn btn-retry" onclick="retryAbsen()">Kirim Ulang</button>`;
      }
    });
  </script>
</body>
</html>
